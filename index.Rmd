
---
title: "PM566 Final Project"
author: "Xiaoyu Zhu"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
---

<br>

This is my PM566 Final Project website. I will showcase a few interactive visuals here.

(Your output should look something like this)

<br>

```{r setup, message=FALSE, echo=FALSE, warning=FALSE}
# import library
library(data.table)
library(dplyr)
library(plotly)
library(DT)
library(knitr)
library(tidyverse) 
library(ggchicklet)
library(cowplot)
library(hrbrthemes)
library(ggalt)
library(GGally)
library(rwa)
library(psych)

# Initialize code chunk options
opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  eval=TRUE,
  echo = TRUE,
  cache = FALSE,
  fig.width = 7, 
  fig.align = 'center',
  fig.asp = 0.618,
  out.width = "700px",
  class.source = "code-r")
```

```{css, echo = FALSE}
.code-r { /* Code block */
  font-size: 15px;
}

.code-r-small { /* Code block */
  font-size: 10px;
}
```

<br>

# Introduction


World Happiness Report 2021 use data that come from the Gallup World Poll surveys from 2018 to 2020. They are based on answers to the main life evaluation question asked in the poll. This is called the Cantril ladder: it asks respondents to think of a ladder, with the best possible life for them being a 10, and the worst possible life being a 0. They are then asked to rate their own current lives on that 0 to 10 scale. The rankings are from nationally representative samples, for the years 2018-2020. They are based entirely on the survey scores, using the Gallup weights to make the estimates representative. 
<br>
the data concludes main variable that is Ladder.score, leading to the core index of people happiness. There are other six variables that researchers put into data frame:
<br>
Logged.GDP.per.capita: means logged GDP every captical
<br>
Social.support: the quality of social support 
<br>
Healthy.life.expectancy: healthy or not
<br>
Freedom.to.make.life.choices: people's feeling on freedom to make life choice
<br>
Generosity: the quality of being kind and generous.
<br>
Perceptions.of.corruption: the perceptions of corruption

And we want to illustrates data storytelling with the World Happiness Report (2021) data. Also we want to know what variable is related to people happiness from perspective of country.


First I will source any necessary code, e.g. `process_covid_data.R`:

```{r load-data}
#read the data
happy_2021<-read.csv("world-happiness-report-2021.csv")

```

<br>

# Method

Then I will add some code to create the **plotly** figures
```{r table1, class.source="code-r-small"}
#briefly check the data
head(happy_2021)
```

```{r table2, class.source="code-r-small"}
describe(happy_2021)
```

```{r plot1, class.source="code-r-small"}
# see the distribution of people happiness
p1_scatter<-
happy_2021%>%
ggplot(aes(x=Regional.indicator,y=Ladder.score,color=Regional.indicator))+
  geom_point()+
  geom_boxplot()
```

```{r plot2, class.source="code-r-small"}
p2_scatter<-
# see the distribution of GDP
happy_2021%>%
ggplot(aes(x=Regional.indicator,y=Logged.GDP.per.capita,color=Regional.indicator))+
  geom_point()+
  geom_boxplot()
```

```{r plot3, class.source="code-r-small"}
# see the distribution of social support
p3_scatter<-
happy_2021%>%
ggplot(aes(x=Regional.indicator,y=Social.support,color=Regional.indicator))+
  geom_point()+
  geom_boxplot()
```

```{r plot4, class.source="code-r-small"}
# see the distribution of life expectancy
p4_scatter<-
happy_2021%>% 
ggplot(aes(x=Regional.indicator,y=Healthy.life.expectancy,color=Regional.indicator))+
  geom_point()+
  geom_boxplot()
```

```{r plot5, class.source="code-r-small"}
# see the distribution of freedom to make life choices
p5_scatter<-
happy_2021%>%
ggplot(aes(x=Regional.indicator,y=Freedom.to.make.life.choices,color=Regional.indicator))+
  geom_point()+
  geom_boxplot()
```
Create tabs to display each figure

### Scatterplot1

```{r p1}
p1_scatter
```

### Scatterplot2

```{r p2}
p2_scatter
```
### Scatterplot3

```{r p3}
p3_scatter
```

### Scatterplot4

```{r p4}
p4_scatter
```

### Scatterplot5

```{r p5}
p5_scatter
```

<br>

# Preliminary Result
<br>
## Fig 1. Ten happinest countries in the world
```{r}
# dimensions
dimensions <- c('Ladder.score','Logged.GDP.per.capita','Social.support','Healthy.life.expectancy','Freedom.to.make.life.choices','Generosity','Perceptions.of.corruption')

# map country to regions
country_region_dict = happy_2021 %>% select(country = Country.name, region = Regional.indicator) %>% unique()

happy_2021_long <- happy_2021 %>% 
    select(country = Country.name, all_of(dimensions)) %>%
    mutate(absence_of_corruption = 1- Perceptions.of.corruption) %>%
    pivot_longer(cols = c(all_of(dimensions),'absence_of_corruption'), names_to = 'dimension', values_to = 'score') %>%
    filter(dimension != "Perceptions.of.corruption")

happy_2021_tranformed <- happy_2021_long %>%
    group_by(dimension) %>%
    mutate(min_value = min(score),
             max_value = max(score)) %>%
    mutate(score_pct = (score-min_value)/(max_value-min_value)) %>%
    ungroup()
# get top 10
happy_2021_top10 <- happy_2021_tranformed %>%
    filter(dimension == "Ladder.score") %>%
    slice_max(score, n = 10) %>%
    mutate(cat = 'top_10', 
           country_rank = rank(-score),
           country_label = paste0(country, ' (', country_rank, ')'))

# get bottom 10
happy_2021_bottom10 <- happy_2021_tranformed %>%
    filter(dimension == "Ladder.score") %>%
    mutate(country_rank = rank(score),
           country_label = paste0(country, ' (', country_rank, ')')) %>%
    slice_min(score, n = 10) %>%
    mutate(cat = 'bottom_10')

```


```{r}

ggplot(happy_2021_top10, aes(x = reorder(country_label, score))) + 
  geom_chicklet(aes(y = 10, fill = 4.88), width = 0.88) +
  geom_chicklet(aes(y = score, fill = score), width = 0.88) +
  geom_text(aes(y = score), label = round(happy_2021_top10$score,2), nudge_y = 0.4, size = 6) + 
  scale_y_continuous(expand = c(0, 0.1), position = "right", limits = c(0, 10)) +
  scale_fill_gradient2(low = '#bc9575', high = '#7FB188', mid = 'white', midpoint = 5) + 
  coord_flip() +
  labs(y="Happinest possible life = 10", x = '',
       title="10 Happiest Countries in the World")
```
<br>
## Fig 2. Ten saddest countries in the world
```{r}

ggplot(happy_2021_bottom10, aes(x = reorder(country_label, score))) + 
  geom_chicklet(aes(y = 10, fill = 4.88), width = 0.88) +
  geom_chicklet(aes(y = score, fill = score), width = 0.88) +
  geom_text(aes(y = score), label = round(happy_2021_bottom10$score,2), nudge_y = 0.4, size = 6) + 
  scale_y_continuous(expand = c(0, 0.1), position = "right", limits = c(0, 10)) +
  scale_fill_gradient2(low = '#656667', high = '#bc9575', mid = 'white', midpoint = 5) + 
  coord_flip() +
  labs(y="Happinest possible life = 10", x = '',
       title="10 Saddest Countries in the World",
       subtitle="Countries torn by poverty and war",
       caption="Source: The World Happiness Report 2021") 
  
```
<br>
## Fig 3. Correlation Matrix
### What factors most strongly correlate with happiness?
```{r}
happy_cor <- happy_2021 %>% 
    select(corruption = Perceptions.of.corruption,
           generosity = Generosity,
           freedom = Freedom.to.make.life.choices, 
           life_expectancy = Healthy.life.expectancy, 
           social_support = Social.support,
           GDP_per_capita = Logged.GDP.per.capita, 
           happiness = Ladder.score
           )
```

```{r}
ggcorr(happy_cor, 
       method = c("everything", "pearson"), 
       low = '#bac2d4', mid = '#d4d1cd', high = "#a7797f",
       label = TRUE, label_size = 6,
       layout.exp = 1) +
labs(title = 'Correlation Matrix',
    subtitle = 'Happiness most strongly correlates with (1) wealth (GDP)\n(2) health, (3) social support, and (4) freedom') 

```
<br>


```{r}
library(caTools)
library(ggplot2)
library(lattice)
library(caret)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidyverse)
library(MASS)
library(ggdark)
df <- read.csv("/kaggle/input/world-happiness-report-2021/world-happiness-report-2021.csv")
View(df)
```

```{r}
#---------------------------Data Visualization-------------------------------

#Regional Indicator
data=df[,1:12]
View(data)

(by_Reional <- data %>% group_by(Regional.indicator))
View(by_Reional)


pl<- ggplot(data, aes(Regional.indicator, Ladder.score)) 
pl+ geom_boxplot(aes(fill = factor(Regional.indicator)))+coord_flip()

```

```{r}
#pie chart

Region_Scores <- aggregate(data$Ladder.score, by=list(Reions=data$Regional.indicator), FUN=mean)

Region_Score_sort = arrange(Region_Scores, desc(Region_Scores$x))
Region_Score_sort

x <- Region_Scores$x
lables <- Region_Scores$Reions

pie(x, lables, main = "Regional.indicator scores" ,col = rainbow(length(x)))
```

```{r}
#Scatter plot

ggplot(data = data , mapping = aes( x = Logged.GDP.per.capita, y =Ladder.score ,col= as.factor(Regional.indicator), size=Ladder.score))+ geom_point()
library("ggpubr")

fig1 <- ggplot(data = data , mapping = aes( x = Logged.GDP.per.capita, y =Ladder.score ,col= as.factor(Regional.indicator), size=Ladder.score))+ geom_point()+ theme(legend.position="top")
fig2 <- ggplot(data = data , mapping = aes( x = Social.support, y =Ladder.score ,col= as.factor(Regional.indicator), size=Ladder.score))+ geom_point()+theme(legend.position = "none")

fig3 <- ggplot(data = data , mapping = aes( x = Healthy.life.expectancy, y =Ladder.score ,col= as.factor(Regional.indicator), size=Ladder.score))+ geom_point()+theme(legend.position = "none")

fig4 <- ggplot(data = data , mapping = aes( x = Freedom.to.make.life.choices, y =Ladder.score ,col= as.factor(Regional.indicator), size=Ladder.score))+ geom_point()+theme(legend.position = "none")

fig5 <- ggplot(data = data , mapping = aes( x = Generosity, y =Ladder.score ,col= as.factor(Regional.indicator), size=Ladder.score))+ geom_point()+theme(legend.position = "none")

fig6 <- ggplot(data = data , mapping = aes( x = Perceptions.of.corruption, y =Ladder.score ,col= as.factor(Regional.indicator), size=Ladder.score))+ geom_point()+theme(legend.position = "none")



figure <- ggarrange(fig1, fig2, fig3, fig4, fig5, fig6,
                    ncol = 2, nrow = 3)
figure

```

```{r}
#----------------bar plot--------------
Region_Score_sort = arrange(Region_Scores, desc(Region_Scores$x))
Region_Score_sort

barplot(height= Region_Score_sort$x , xlab= 'Life Scores' , main ='Life Score of Regions', beside = T,
        names.arg = Region_Score_sort$Reions , horiz = T , col=Region_Score_sort$x, las = 2 , 
        cex.names = 0.5)
```

```{r}
#---------------Countries---------------------------------------------------------------------------------

q10 = quantile(data$Ladder.score, 0.10)
q90 = quantile(data$Ladder.score, 0.90)
q90

Best_Countries=subset(data, data$Ladder.score >= q90 )
Worse_Countries=subset(data, data$Ladder.score <= q10 )
Best_and_Worse_Countries = rbind(Best_Countries,Worse_Countries )
View(Best_and_Worse_Countries)


barplot(height= Best_and_Worse_Countries$Ladder.score , xlab= 'Life Scores' , main ='Life Score of Best and Worse Countries', beside = T,
        names.arg = Best_and_Worse_Countries$Ã¯..Country.name , horiz = T , col=Best_and_Worse_Countries$Ladder.score, las = 2 , 
        cex.names = 0.5)


ggplot(data = Best_and_Worse_Countries , mapping = aes( x = Logged.GDP.per.capita, y =Ladder.score ,col= 
                                      as.factor(Country.name), size=Ladder.score))+ geom_point()+ theme_dark()



```

```{r}
library("ggpubr")

fig1 <- ggplot(data = Best_and_Worse_Countries , mapping = aes( x = Logged.GDP.per.capita, y =Ladder.score ,col= 
                                                                  as.factor(Country.name), size=Ladder.score))+ geom_point()+ theme(legend.position="left")


fig2 <- ggplot(data = Best_and_Worse_Countries , mapping = aes( x = Social.support, y =Ladder.score ,col= 
                                                                  as.factor(Country.name), size=Ladder.score))+ geom_point()+theme(legend.position = "none")

fig3 <- ggplot(data = Best_and_Worse_Countries , mapping = aes( x = Healthy.life.expectancy, y =Ladder.score ,col= 
                                                                  as.factor(Country.name), size=Ladder.score))+ geom_point()+theme(legend.position = "none")


fig4 <- ggplot(data = Best_and_Worse_Countries , mapping = aes( x = Freedom.to.make.life.choices, y =Ladder.score ,col= 
                                                                  as.factor(Country.name), size=Ladder.score))+ geom_point()+theme(legend.position = "none")



fig5 <- ggplot(data = Best_and_Worse_Countries , mapping = aes( x = Generosity, y =Ladder.score ,col= 
                                                                  as.factor(Country.name), size=Ladder.score))+ geom_point()+theme(legend.position = "none")

figure <- ggarrange(fig1, fig2, fig3, fig4, fig5, fig6,
                    ncol = 2, nrow = 3)
figure

```

```{r}
#----------------------report for all years--------------------
df_y<- read_csv("/kaggle/input/world-happiness-report-2021/world-happiness-report.csv")
View(df_y)
#sorting countries based on mean Scores over years and selecting top 10
countries_Scores <- aggregate(df_y$`Life Ladder`, by=list(Country=df_y$`Country name`), FUN=mean)

Country_Score_sort = arrange(countries_Scores, desc(countries_Scores$x))
Country_Score_sort

#selecting top 10 countries in year 2020

(Top_Countries = Country_Score_sort[1:10,])

df_2020=subset(df_y, df_y$year == 2020)
countries_Scores_2020 = arrange(df_2020,desc(df_2020$`Life Ladder`) )
top_contries2020 = countries_Scores_2020[1:10,c(1,3)]
top_contries2020

df_Finland =filter(df_y, `Country name` == 'Finland')

plot(df_Finland$year, df_Finland$`Life Ladder` , type ="l" , lwd=2 , lty = 1 , 
     col = "Orange" , main = "Life Ladder over Years in Finland")


#plot scores of top contires over years in a graph usinf ggplot
top_countries <- c('Finland', 'Iceland','Denmark','Switzerland', 'Netherlands','Norway'  )

df_top_countries <- filter(df_y, `Country name` %in% top_countries)

View(df_top_countries)
df_top_countries_1 <- df_top_countries[,1:3]


ggplot(df_top_countries_1, aes(x = year, y = `Life Ladder`)) + 
        geom_line(aes(color =`Country name`, linetype = `Country name`), size = 1.1) + 
        scale_color_manual(values = c("darkred", "steelblue" , "red" , "blue", "yellow", "green"))+ theme_dark()


```


```{r}
#--------------Forecasting_______________________________________________________________---

View(df_y)

data_year <- data.frame(
        Country_name = df_y$`Country name`,
        year = df_y$year,
        Log_GDP_per_capita = df_y$`Log GDP per capita`,
        Social_support = df_y$`Social support`,
        Healthy_life_expectancy_at_birth = df_y$`Healthy life expectancy at birth`,
        Freedom_to_make_life_choices = df_y$`Freedom to make life choices`,
        Generosity = df_y$Generosity,
        Perceptions_of_corruption= df_y$`Perceptions of corruption`,
        Positive_affect= df_y$`Positive affect`,
        Negative_affect= df_y$`Negative affect`,
        Life_Ladder = df_y$`Life Ladder`
)


data_f <- data_year

sum(is.na(data_f))
dim(data_f)

data_f <- na.omit(data_f)
dim(data_f)

data_f$year <- as.integer(as.factor(data_f$year))
data_f$Country_name <- as.integer(as.factor(data_f$Country_name ))


View(data_f)
```

# Conclusion

The happiness regions in the world are North America and Western Europe.
The unhappiness regions in the world are sahara Africa and Middle East, maybe for the reason of poverty and war.
Three top drivers of happiness:
(1) Wealth
(2) Health
(3) Social support

<br>